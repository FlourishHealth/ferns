{"ast":null,"code":"'use strict';import{runOnUIImmediately}from'../threads';var _worklet_8640414198951_init_data={code:\"function anonymous(){const frameCallbackRegistry={frameCallbackRegistry:new Map(),activeFrameCallbacks:new Set(),previousFrameTimestamp:null,nextCallId:0,runCallbacks:function(callId){var _this=this;const loop=function(timestamp){if(callId!==_this.nextCallId){return;}if(_this.previousFrameTimestamp===null){_this.previousFrameTimestamp=timestamp;}const delta=timestamp-_this.previousFrameTimestamp;_this.activeFrameCallbacks.forEach(function(callbackId){const callbackDetails=_this.frameCallbackRegistry.get(callbackId);const{startTime:startTime}=callbackDetails;if(startTime===null){callbackDetails.startTime=timestamp;callbackDetails.callback({timestamp:timestamp,timeSincePreviousFrame:null,timeSinceFirstFrame:0});}else{callbackDetails.callback({timestamp:timestamp,timeSincePreviousFrame:delta,timeSinceFirstFrame:timestamp-startTime});}});if(_this.activeFrameCallbacks.size>0){_this.previousFrameTimestamp=timestamp;requestAnimationFrame(loop);}else{_this.previousFrameTimestamp=null;}};if(this.activeFrameCallbacks.size===1&&callId===this.nextCallId){requestAnimationFrame(loop);}},registerFrameCallback:function(callback,callbackId){this.frameCallbackRegistry.set(callbackId,{callback:callback,startTime:null});},unregisterFrameCallback:function(callbackId){this.manageStateFrameCallback(callbackId,false);this.frameCallbackRegistry.delete(callbackId);},manageStateFrameCallback:function(callbackId,state){if(callbackId===-1){return;}if(state){this.activeFrameCallbacks.add(callbackId);this.runCallbacks(this.nextCallId);}else{const callback=this.frameCallbackRegistry.get(callbackId);callback.startTime=null;this.activeFrameCallbacks.delete(callbackId);if(this.activeFrameCallbacks.size===0){this.nextCallId+=1;}}}};global._frameCallbackRegistry=frameCallbackRegistry;}\"};export var prepareUIRegistry=runOnUIImmediately(function(){var anonymous=function anonymous(){var frameCallbackRegistry={frameCallbackRegistry:new Map(),activeFrameCallbacks:new Set(),previousFrameTimestamp:null,nextCallId:0,runCallbacks:function runCallbacks(callId){var _this=this;var loop=function loop(timestamp){if(callId!==_this.nextCallId){return;}if(_this.previousFrameTimestamp===null){_this.previousFrameTimestamp=timestamp;}var delta=timestamp-_this.previousFrameTimestamp;_this.activeFrameCallbacks.forEach(function(callbackId){var callbackDetails=_this.frameCallbackRegistry.get(callbackId);var startTime=callbackDetails.startTime;if(startTime===null){callbackDetails.startTime=timestamp;callbackDetails.callback({timestamp:timestamp,timeSincePreviousFrame:null,timeSinceFirstFrame:0});}else{callbackDetails.callback({timestamp:timestamp,timeSincePreviousFrame:delta,timeSinceFirstFrame:timestamp-startTime});}});if(_this.activeFrameCallbacks.size>0){_this.previousFrameTimestamp=timestamp;requestAnimationFrame(loop);}else{_this.previousFrameTimestamp=null;}};if(this.activeFrameCallbacks.size===1&&callId===this.nextCallId){requestAnimationFrame(loop);}},registerFrameCallback:function registerFrameCallback(callback,callbackId){this.frameCallbackRegistry.set(callbackId,{callback:callback,startTime:null});},unregisterFrameCallback:function unregisterFrameCallback(callbackId){this.manageStateFrameCallback(callbackId,false);this.frameCallbackRegistry.delete(callbackId);},manageStateFrameCallback:function manageStateFrameCallback(callbackId,state){if(callbackId===-1){return;}if(state){this.activeFrameCallbacks.add(callbackId);this.runCallbacks(this.nextCallId);}else{var callback=this.frameCallbackRegistry.get(callbackId);callback.startTime=null;this.activeFrameCallbacks.delete(callbackId);if(this.activeFrameCallbacks.size===0){this.nextCallId+=1;}}}};global._frameCallbackRegistry=frameCallbackRegistry;};anonymous.__closure={};anonymous.__workletHash=8640414198951;anonymous.__initData=_worklet_8640414198951_init_data;return anonymous;}());","map":{"version":3,"sources":["FrameCallbackRegistryUI.ts"],"names":["runOnUIImmediately","prepareUIRegistry","frameCallbackRegistry","Map","activeFrameCallbacks","Set","previousFrameTimestamp","nextCallId","runCallbacks","callId","loop","timestamp","delta","forEach","callbackId","callbackDetails","get","startTime","callback","timeSincePreviousFrame","timeSinceFirstFrame","size","requestAnimationFrame","registerFrameCallback","set","unregisterFrameCallback","manageStateFrameCallback","delete","state","add","global","_frameCallbackRegistry"],"mappings":"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","sourcesContent":["'use strict';\nimport { runOnUIImmediately } from '../threads';\n\ntype CallbackDetails = {\n  callback: (frameInfo: FrameInfo) => void;\n  startTime: number | null;\n};\n\nexport type FrameInfo = {\n  timestamp: number;\n  timeSincePreviousFrame: number | null;\n  timeSinceFirstFrame: number;\n};\n\nexport interface FrameCallbackRegistryUI {\n  frameCallbackRegistry: Map<number, CallbackDetails>;\n  activeFrameCallbacks: Set<number>;\n  previousFrameTimestamp: number | null;\n  runCallbacks: (callId: number) => void;\n  nextCallId: number;\n  registerFrameCallback: (\n    callback: (frameInfo: FrameInfo) => void,\n    callbackId: number\n  ) => void;\n  unregisterFrameCallback: (callbackId: number) => void;\n  manageStateFrameCallback: (callbackId: number, state: boolean) => void;\n}\n\nexport const prepareUIRegistry = runOnUIImmediately(() => {\n  'worklet';\n\n  const frameCallbackRegistry: FrameCallbackRegistryUI = {\n    frameCallbackRegistry: new Map<number, CallbackDetails>(),\n    activeFrameCallbacks: new Set<number>(),\n    previousFrameTimestamp: null,\n    nextCallId: 0,\n\n    runCallbacks(callId) {\n      const loop = (timestamp: number) => {\n        if (callId !== this.nextCallId) {\n          return;\n        }\n        if (this.previousFrameTimestamp === null) {\n          this.previousFrameTimestamp = timestamp;\n        }\n\n        const delta = timestamp - this.previousFrameTimestamp;\n\n        this.activeFrameCallbacks.forEach((callbackId: number) => {\n          const callbackDetails = this.frameCallbackRegistry.get(callbackId)!;\n\n          const { startTime } = callbackDetails;\n\n          if (startTime === null) {\n            // First frame\n            callbackDetails.startTime = timestamp;\n\n            callbackDetails.callback({\n              timestamp,\n              timeSincePreviousFrame: null,\n              timeSinceFirstFrame: 0,\n            });\n          } else {\n            // Next frame\n            callbackDetails.callback({\n              timestamp,\n              timeSincePreviousFrame: delta,\n              timeSinceFirstFrame: timestamp - startTime,\n            });\n          }\n        });\n\n        if (this.activeFrameCallbacks.size > 0) {\n          this.previousFrameTimestamp = timestamp;\n          requestAnimationFrame(loop);\n        } else {\n          this.previousFrameTimestamp = null;\n        }\n      };\n\n      // runCallback() should only be called after registering a callback,\n      // so if there is only one active callback, then it means that there were\n      // zero previously and the loop isn't running yet.\n      if (this.activeFrameCallbacks.size === 1 && callId === this.nextCallId) {\n        requestAnimationFrame(loop);\n      }\n    },\n\n    registerFrameCallback(\n      callback: (frameInfo: FrameInfo) => void,\n      callbackId: number\n    ) {\n      this.frameCallbackRegistry.set(callbackId, {\n        callback: callback,\n        startTime: null,\n      });\n    },\n\n    unregisterFrameCallback(callbackId: number) {\n      this.manageStateFrameCallback(callbackId, false);\n      this.frameCallbackRegistry.delete(callbackId);\n    },\n\n    manageStateFrameCallback(callbackId: number, state: boolean) {\n      if (callbackId === -1) {\n        return;\n      }\n      if (state) {\n        this.activeFrameCallbacks.add(callbackId);\n        this.runCallbacks(this.nextCallId);\n      } else {\n        const callback = this.frameCallbackRegistry.get(callbackId)!;\n        callback.startTime = null;\n\n        this.activeFrameCallbacks.delete(callbackId);\n        if (this.activeFrameCallbacks.size === 0) {\n          this.nextCallId += 1;\n        }\n      }\n    },\n  };\n\n  global._frameCallbackRegistry = frameCallbackRegistry;\n});\n"]},"metadata":{},"sourceType":"module"}