{"ast":null,"code":"'use strict';import _slicedToArray from\"@babel/runtime/helpers/slicedToArray\";import NativeReanimatedModule from'./NativeReanimated';import{shouldBeUseWeb}from'./PlatformChecker';import{registerWorkletStackDetails}from'./errors';import{jsVersion}from'./platform-specific/jsVersion';var USE_STUB_IMPLEMENTATION=shouldBeUseWeb();var _shareableCache=new WeakMap();var _shareableFlag=Symbol('shareable flag');var MAGIC_KEY='REANIMATED_MAGIC_KEY';var _worklet_6457566696199_init_data={code:\"function isHostObject(value){const{MAGIC_KEY}=this.__closure;return MAGIC_KEY in value;}\"};var isHostObject=function(){var isHostObject=function isHostObject(value){return MAGIC_KEY in value;};isHostObject.__closure={MAGIC_KEY:MAGIC_KEY};isHostObject.__workletHash=6457566696199;isHostObject.__initData=_worklet_6457566696199_init_data;return isHostObject;}();export function registerShareableMapping(shareable,shareableRef){if(USE_STUB_IMPLEMENTATION){return;}_shareableCache.set(shareable,shareableRef||_shareableFlag);}function isPlainJSObject(object){return Object.getPrototypeOf(object)===Object.prototype;}var _worklet_17186589908483_init_data={code:\"function anonymous(){return new Proxy({},{get:function(_,prop){if(prop==='_isReanimatedSharedValue'||prop==='__remoteFunction'){return false;}throw new Error(\\\"[Reanimated] Trying to access property `\\\"+String(prop)+\\\"` of an object which cannot be sent to the UI runtime.\\\");},set:function(){throw new Error('[Reanimated] Trying to write to an object which cannot be sent to the UI runtime.');}});}\"};var INACCESSIBLE_OBJECT={__init:function(){var anonymous=function anonymous(){return new Proxy({},{get:function get(_,prop){if(prop==='_isReanimatedSharedValue'||prop==='__remoteFunction'){return false;}throw new Error(`[Reanimated] Trying to access property \\`${String(prop)}\\` of an object which cannot be sent to the UI runtime.`);},set:function set(){throw new Error('[Reanimated] Trying to write to an object which cannot be sent to the UI runtime.');}});};anonymous.__closure={};anonymous.__workletHash=17186589908483;anonymous.__initData=_worklet_17186589908483_init_data;return anonymous;}()};var VALID_ARRAY_VIEWS_NAMES=['Int8Array','Uint8Array','Uint8ClampedArray','Int16Array','Uint16Array','Int32Array','Uint32Array','Float32Array','Float64Array','BigInt64Array','BigUint64Array','DataView'];var DETECT_CYCLIC_OBJECT_DEPTH_THRESHOLD=30;var processedObjectAtThresholdDepth;var shouldWarnAboutMissingPluginVersion=true;var _worklet_17031627990684_init_data={code:\"function anonymous(){const{pattern,flags}=this.__closure;return new RegExp(pattern,flags);}\"};var _worklet_7802327914260_init_data={code:\"function anonymous(){const{VALID_ARRAY_VIEWS_NAMES,_type,buffer}=this.__closure;if(!VALID_ARRAY_VIEWS_NAMES.includes(_type)){throw new Error(\\\"[Reanimated] Invalid array view name `\\\"+_type+\\\"`.\\\");}const constructor=global[_type];if(constructor===undefined){throw new Error(\\\"[Reanimated] Constructor for `\\\"+_type+\\\"` not found.\\\");}return new constructor(buffer);}\"};export function makeShareableCloneRecursive(value){var shouldPersistRemote=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;var depth=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;if(USE_STUB_IMPLEMENTATION){return value;}if(depth>=DETECT_CYCLIC_OBJECT_DEPTH_THRESHOLD){if(depth===DETECT_CYCLIC_OBJECT_DEPTH_THRESHOLD){processedObjectAtThresholdDepth=value;}else if(value===processedObjectAtThresholdDepth){throw new Error('[Reanimated] Trying to convert a cyclic object to a shareable. This is not supported.');}}else{processedObjectAtThresholdDepth=undefined;}var type=typeof value;var isTypeObject=type==='object';var isTypeFunction=type==='function';if((isTypeObject||isTypeFunction)&&value!==null){var cached=_shareableCache.get(value);if(cached===_shareableFlag){return value;}else if(cached!==undefined){return cached;}else{var toAdapt;if(Array.isArray(value)){toAdapt=value.map(function(element){return makeShareableCloneRecursive(element,shouldPersistRemote,depth+1);});}else if(isTypeFunction&&value.__workletHash===undefined){toAdapt=value;}else if(isHostObject(value)){toAdapt=value;}else if(isPlainJSObject(value)||isTypeFunction){toAdapt={};if(value.__workletHash!==undefined){if(false){var babelVersion=value.__initData.version;if(babelVersion===undefined){if(shouldWarnAboutMissingPluginVersion){shouldWarnAboutMissingPluginVersion=false;console.warn(`[Reanimated] Unknown version of Reanimated Babel plugin.\n              See \\`https://docs.swmansion.com/react-native-reanimated/docs/guides/troubleshooting#unknown-version-of-reanimated-babel-plugin\\` for more details.\n              Offending code was: \\`${getWorkletCode(value)}\\``);}}else if(babelVersion!==jsVersion){throw new Error(`[Reanimated] Mismatch between JavaScript code version and Reanimated Babel plugin version (${jsVersion} vs. ${babelVersion}).        \nSee \\`https://docs.swmansion.com/react-native-reanimated/docs/guides/troubleshooting#mismatch-between-javascript-code-version-and-reanimated-babel-plugin-version\\` for more details.\nOffending code was: \\`${getWorkletCode(value)}\\``);}registerWorkletStackDetails(value.__workletHash,value.__stackDetails);}if(value.__stackDetails){delete value.__stackDetails;}toAdapt.__initData=makeShareableCloneRecursive(value.__initData,true,depth+1);}for(var _ref of Object.entries(value)){var _ref2=_slicedToArray(_ref,2);var key=_ref2[0];var element=_ref2[1];if(key==='__initData'&&toAdapt.__initData!==undefined){continue;}toAdapt[key]=makeShareableCloneRecursive(element,shouldPersistRemote,depth+1);}}else if(value instanceof RegExp){var pattern=value.source;var flags=value.flags;var handle=makeShareableCloneRecursive({__init:function(){var anonymous=function anonymous(){return new RegExp(pattern,flags);};anonymous.__closure={pattern:pattern,flags:flags};anonymous.__workletHash=17031627990684;anonymous.__initData=_worklet_17031627990684_init_data;return anonymous;}()});registerShareableMapping(value,handle);return handle;}else if(value instanceof ArrayBuffer){toAdapt=value;}else if(ArrayBuffer.isView(value)){var buffer=value.buffer;var _type=value.constructor.name;var _handle=makeShareableCloneRecursive({__init:function(){var anonymous=function anonymous(){if(!VALID_ARRAY_VIEWS_NAMES.includes(_type)){throw new Error(`[Reanimated] Invalid array view name \\`${_type}\\`.`);}var constructor=global[_type];if(constructor===undefined){throw new Error(`[Reanimated] Constructor for \\`${_type}\\` not found.`);}return new constructor(buffer);};anonymous.__closure={VALID_ARRAY_VIEWS_NAMES:VALID_ARRAY_VIEWS_NAMES,_type:_type,buffer:buffer};anonymous.__workletHash=7802327914260;anonymous.__initData=_worklet_7802327914260_init_data;return anonymous;}()});registerShareableMapping(value,_handle);return _handle;}else{var inaccessibleObject=makeShareableCloneRecursive(INACCESSIBLE_OBJECT);_shareableCache.set(value,inaccessibleObject);return inaccessibleObject;}if(false){Object.freeze(value);}var adopted=NativeReanimatedModule.makeShareableClone(toAdapt,shouldPersistRemote);_shareableCache.set(value,adopted);_shareableCache.set(adopted,_shareableFlag);return adopted;}}return NativeReanimatedModule.makeShareableClone(value,shouldPersistRemote);}var WORKLET_CODE_THRESHOLD=255;function getWorkletCode(value){var _value$__initData;var code=value===null||value===void 0?void 0:(_value$__initData=value.__initData)===null||_value$__initData===void 0?void 0:_value$__initData.code;if(!code){return'unknown';}if(code.length>WORKLET_CODE_THRESHOLD){return`${code.substring(0,WORKLET_CODE_THRESHOLD)}...`;}return code;}var _worklet_11770591563495_init_data={code:\"function isRemoteFunction(value){return!!value.__remoteFunction;}\"};var isRemoteFunction=function(){var isRemoteFunction=function isRemoteFunction(value){return!!value.__remoteFunction;};isRemoteFunction.__closure={};isRemoteFunction.__workletHash=11770591563495;isRemoteFunction.__initData=_worklet_11770591563495_init_data;return isRemoteFunction;}();var _worklet_6696410489807_init_data={code:\"function makeShareableCloneOnUIRecursive(value){const{USE_STUB_IMPLEMENTATION,isHostObject,isRemoteFunction}=this.__closure;if(USE_STUB_IMPLEMENTATION){return value;}function cloneRecursive(value){if(typeof value==='object'&&value!==null||typeof value==='function'){if(isHostObject(value)){return _makeShareableClone(value);}if(isRemoteFunction(value)){return value.__remoteFunction;}if(Array.isArray(value)){return _makeShareableClone(value.map(cloneRecursive));}const toAdapt={};for(const[key,element]of Object.entries(value)){toAdapt[key]=cloneRecursive(element);}return _makeShareableClone(toAdapt);}return _makeShareableClone(value);}return cloneRecursive(value);}\"};export var makeShareableCloneOnUIRecursive=function(){var makeShareableCloneOnUIRecursive=function makeShareableCloneOnUIRecursive(value){if(USE_STUB_IMPLEMENTATION){return value;}function cloneRecursive(value){if(typeof value==='object'&&value!==null||typeof value==='function'){if(isHostObject(value)){return _makeShareableClone(value);}if(isRemoteFunction(value)){return value.__remoteFunction;}if(Array.isArray(value)){return _makeShareableClone(value.map(cloneRecursive));}var toAdapt={};for(var _ref3 of Object.entries(value)){var _ref4=_slicedToArray(_ref3,2);var key=_ref4[0];var element=_ref4[1];toAdapt[key]=cloneRecursive(element);}return _makeShareableClone(toAdapt);}return _makeShareableClone(value);}return cloneRecursive(value);};makeShareableCloneOnUIRecursive.__closure={USE_STUB_IMPLEMENTATION:USE_STUB_IMPLEMENTATION,isHostObject:isHostObject,isRemoteFunction:isRemoteFunction};makeShareableCloneOnUIRecursive.__workletHash=6696410489807;makeShareableCloneOnUIRecursive.__initData=_worklet_6696410489807_init_data;return makeShareableCloneOnUIRecursive;}();var _worklet_15913789835932_init_data={code:\"function anonymous(){const{value}=this.__closure;return value;}\"};export function makeShareable(value){if(USE_STUB_IMPLEMENTATION){return value;}var handle=makeShareableCloneRecursive({__init:function(){var anonymous=function anonymous(){return value;};anonymous.__closure={value:value};anonymous.__workletHash=15913789835932;anonymous.__initData=_worklet_15913789835932_init_data;return anonymous;}()});registerShareableMapping(value,handle);return value;}","map":{"version":3,"sources":["shareables.ts"],"names":["NativeReanimatedModule","shouldBeUseWeb","registerWorkletStackDetails","jsVersion","USE_STUB_IMPLEMENTATION","_shareableCache","WeakMap","_shareableFlag","Symbol","MAGIC_KEY","isHostObject","value","registerShareableMapping","shareable","shareableRef","set","isPlainJSObject","object","Object","getPrototypeOf","prototype","INACCESSIBLE_OBJECT","__init","Proxy","get","_","prop","Error","String","VALID_ARRAY_VIEWS_NAMES","DETECT_CYCLIC_OBJECT_DEPTH_THRESHOLD","processedObjectAtThresholdDepth","shouldWarnAboutMissingPluginVersion","makeShareableCloneRecursive","shouldPersistRemote","depth","undefined","type","isTypeObject","isTypeFunction","cached","toAdapt","Array","isArray","map","element","__workletHash","babelVersion","__initData","version","console","warn","getWorkletCode","__stackDetails","key","entries","RegExp","pattern","source","flags","handle","ArrayBuffer","isView","buffer","constructor","name","includes","global","inaccessibleObject","freeze","adopted","makeShareableClone","WORKLET_CODE_THRESHOLD","code","length","substring","isRemoteFunction","__remoteFunction","makeShareableCloneOnUIRecursive","cloneRecursive","_makeShareableClone","makeShareable"],"mappings":"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","sourcesContent":["'use strict';\nimport NativeReanimatedModule from './NativeReanimated';\nimport type {\n  ShareableRef,\n  FlatShareableRef,\n  __WorkletFunction,\n} from './commonTypes';\nimport { shouldBeUseWeb } from './PlatformChecker';\nimport { registerWorkletStackDetails } from './errors';\nimport { jsVersion } from './platform-specific/jsVersion';\n\n// for web/chrome debugger/jest environments this file provides a stub implementation\n// where no shareable references are used. Instead, the objects themselves are used\n// instead of shareable references, because of the fact that we don't have to deal with\n// runnning the code on separate VMs.\nconst USE_STUB_IMPLEMENTATION = shouldBeUseWeb();\n\nconst _shareableCache = new WeakMap<\n  Record<string, unknown>,\n  ShareableRef<unknown> | symbol\n>();\n// the below symbol is used to represent a mapping from the value to itself\n// this is used to allow for a converted shareable to be passed to makeShareableClone\nconst _shareableFlag = Symbol('shareable flag');\n\nconst MAGIC_KEY = 'REANIMATED_MAGIC_KEY';\n\nfunction isHostObject(value: NonNullable<object>) {\n  'worklet';\n  // We could use JSI to determine whether an object is a host object, however\n  // the below workaround works well and is way faster than an additional JSI call.\n  // We use the fact that host objects have broken implementation of `hasOwnProperty`\n  // and hence return true for all `in` checks regardless of the key we ask for.\n  return MAGIC_KEY in value;\n}\n\nexport function registerShareableMapping(\n  shareable: any,\n  shareableRef?: ShareableRef<unknown>\n): void {\n  if (USE_STUB_IMPLEMENTATION) {\n    return;\n  }\n  _shareableCache.set(shareable, shareableRef || _shareableFlag);\n}\n\nfunction isPlainJSObject(object: object) {\n  return Object.getPrototypeOf(object) === Object.prototype;\n}\n\n// The below object is used as a replacement for objects that cannot be transferred\n// as shareable values. In makeShareableCloneRecursive we detect if an object is of\n// a plain Object.prototype and only allow such objects to be transferred. This lets\n// us avoid all sorts of react internals from leaking into the UI runtime. To make it\n// possible to catch errors when someone actually tries to access such object on the UI\n// runtime, we use the below Proxy object which is instantiated on the UI runtime and\n// throws whenever someone tries to access its fields.\nconst INACCESSIBLE_OBJECT = {\n  __init: () => {\n    'worklet';\n    return new Proxy(\n      {},\n      {\n        get: (_: any, prop: string | symbol) => {\n          if (\n            prop === '_isReanimatedSharedValue' ||\n            prop === '__remoteFunction'\n          ) {\n            // not very happy about this check here, but we need to allow for\n            // \"inaccessible\" objects to be tested with isSharedValue check\n            // as it is being used in the mappers when extracting inputs recursively\n            // as well as with isRemoteFunction when cloning objects recursively.\n            // Apparently we can't check if a key exists there as HostObjects always\n            // return true for such tests, so the only possibility for us is to\n            // actually access that key and see if it is set to true. We therefore\n            // need to allow for this key to be accessed here.\n            return false;\n          }\n          throw new Error(\n            `[Reanimated] Trying to access property \\`${String(\n              prop\n            )}\\` of an object which cannot be sent to the UI runtime.`\n          );\n        },\n        set: () => {\n          throw new Error(\n            '[Reanimated] Trying to write to an object which cannot be sent to the UI runtime.'\n          );\n        },\n      }\n    );\n  },\n};\n\nconst VALID_ARRAY_VIEWS_NAMES = [\n  'Int8Array',\n  'Uint8Array',\n  'Uint8ClampedArray',\n  'Int16Array',\n  'Uint16Array',\n  'Int32Array',\n  'Uint32Array',\n  'Float32Array',\n  'Float64Array',\n  'BigInt64Array',\n  'BigUint64Array',\n  'DataView',\n];\n\nconst DETECT_CYCLIC_OBJECT_DEPTH_THRESHOLD = 30;\n// Below variable stores object that we process in makeShareableCloneRecursive at the specified depth.\n// We use it to check if later on the function reenters with the same object\nlet processedObjectAtThresholdDepth: unknown;\n\nlet shouldWarnAboutMissingPluginVersion = true;\n\nexport function makeShareableCloneRecursive<T>(\n  value: any,\n  shouldPersistRemote = false,\n  depth = 0\n): ShareableRef<T> {\n  if (USE_STUB_IMPLEMENTATION) {\n    return value;\n  }\n  if (depth >= DETECT_CYCLIC_OBJECT_DEPTH_THRESHOLD) {\n    // if we reach certain recursion depth we suspect that we are dealing with a cyclic object.\n    // this type of objects are not supported and cannot be trasferred as shareable, so we\n    // implement a simple detection mechanism that remembers the value at a given depth and\n    // tests whether we try reenter this method later on with the same value. If that happens\n    // we throw an appropriate error.\n    if (depth === DETECT_CYCLIC_OBJECT_DEPTH_THRESHOLD) {\n      processedObjectAtThresholdDepth = value;\n    } else if (value === processedObjectAtThresholdDepth) {\n      throw new Error(\n        '[Reanimated] Trying to convert a cyclic object to a shareable. This is not supported.'\n      );\n    }\n  } else {\n    processedObjectAtThresholdDepth = undefined;\n  }\n  // This one actually may be worth to be moved to c++, we also need similar logic to run on the UI thread\n  const type = typeof value;\n  const isTypeObject = type === 'object';\n  const isTypeFunction = type === 'function';\n  if ((isTypeObject || isTypeFunction) && value !== null) {\n    const cached = _shareableCache.get(value);\n    if (cached === _shareableFlag) {\n      return value;\n    } else if (cached !== undefined) {\n      return cached as ShareableRef<T>;\n    } else {\n      let toAdapt: any;\n      if (Array.isArray(value)) {\n        toAdapt = value.map((element) =>\n          makeShareableCloneRecursive(element, shouldPersistRemote, depth + 1)\n        );\n      } else if (isTypeFunction && value.__workletHash === undefined) {\n        // this is a remote function\n        toAdapt = value;\n      } else if (isHostObject(value)) {\n        // for host objects we pass the reference to the object as shareable and\n        // then recreate new host object wrapping the same instance on the UI thread.\n        // there is no point of iterating over keys as we do for regular objects.\n        toAdapt = value;\n      } else if (isPlainJSObject(value) || isTypeFunction) {\n        toAdapt = {};\n        if (value.__workletHash !== undefined) {\n          // we are converting a worklet\n          if (__DEV__) {\n            const babelVersion = value.__initData.version;\n            if (babelVersion === undefined) {\n              if (shouldWarnAboutMissingPluginVersion) {\n                shouldWarnAboutMissingPluginVersion = false;\n                console.warn(`[Reanimated] Unknown version of Reanimated Babel plugin.\n              See \\`https://docs.swmansion.com/react-native-reanimated/docs/guides/troubleshooting#unknown-version-of-reanimated-babel-plugin\\` for more details.\n              Offending code was: \\`${getWorkletCode(value)}\\``);\n              }\n            } else if (babelVersion !== jsVersion) {\n              throw new Error(`[Reanimated] Mismatch between JavaScript code version and Reanimated Babel plugin version (${jsVersion} vs. ${babelVersion}).        \nSee \\`https://docs.swmansion.com/react-native-reanimated/docs/guides/troubleshooting#mismatch-between-javascript-code-version-and-reanimated-babel-plugin-version\\` for more details.\nOffending code was: \\`${getWorkletCode(value)}\\``);\n            }\n            registerWorkletStackDetails(\n              value.__workletHash,\n              value.__stackDetails\n            );\n          }\n          if (value.__stackDetails) {\n            // `Error` type of value cannot be copied to the UI thread, so we\n            // remove it after we handled it in dev mode or delete it to ignore it in production mode.\n            // Not removing this would cause an infinite loop in production mode and it just\n            // seems more elegant to handle it this way.\n            delete value.__stackDetails;\n          }\n          // to save on transferring static __initData field of worklet structure\n          // we request shareable value to persist its UI counterpart. This means\n          // that the __initData field that contains long strings represeting the\n          // worklet code, source map, and location, will always be\n          // serialized/deserialized once.\n          toAdapt.__initData = makeShareableCloneRecursive(\n            value.__initData,\n            true,\n            depth + 1\n          );\n        }\n\n        for (const [key, element] of Object.entries(value)) {\n          if (key === '__initData' && toAdapt.__initData !== undefined) {\n            continue;\n          }\n          toAdapt[key] = makeShareableCloneRecursive(\n            element,\n            shouldPersistRemote,\n            depth + 1\n          );\n        }\n      } else if (value instanceof RegExp) {\n        const pattern = value.source;\n        const flags = value.flags;\n        const handle = makeShareableCloneRecursive({\n          __init: () => {\n            'worklet';\n            return new RegExp(pattern, flags);\n          },\n        });\n        registerShareableMapping(value, handle);\n        return handle as ShareableRef<T>;\n      } else if (value instanceof ArrayBuffer) {\n        toAdapt = value;\n      } else if (ArrayBuffer.isView(value)) {\n        // typed array (e.g. Int32Array, Uint8ClampedArray) or DataView\n        const buffer = value.buffer;\n        const type = value.constructor.name;\n        const handle = makeShareableCloneRecursive({\n          __init: () => {\n            'worklet';\n            if (!VALID_ARRAY_VIEWS_NAMES.includes(type)) {\n              throw new Error(\n                `[Reanimated] Invalid array view name \\`${type}\\`.`\n              );\n            }\n            const constructor = global[type as keyof typeof global];\n            if (constructor === undefined) {\n              throw new Error(\n                `[Reanimated] Constructor for \\`${type}\\` not found.`\n              );\n            }\n            return new constructor(buffer);\n          },\n        });\n        registerShareableMapping(value, handle);\n        return handle as ShareableRef<T>;\n      } else {\n        // This is reached for object types that are not of plain Object.prototype.\n        // We don't support such objects from being transferred as shareables to\n        // the UI runtime and hence we replace them with \"inaccessible object\"\n        // which is implemented as a Proxy object that throws on any attempt\n        // of accessing its fields. We argue that such objects can sometimes leak\n        // as attributes of objects being captured by worklets but should never\n        // be used on the UI runtime regardless. If they are being accessed, the user\n        // will get an appropriate error message.\n        const inaccessibleObject =\n          makeShareableCloneRecursive<T>(INACCESSIBLE_OBJECT);\n        _shareableCache.set(value, inaccessibleObject);\n        return inaccessibleObject;\n      }\n      if (__DEV__) {\n        // we freeze objects that are transformed to shareable. This should help\n        // detect issues when someone modifies data after it's been converted to\n        // shareable. Meaning that they may be doing a faulty assumption in their\n        // code expecting that the updates are going to automatically populate to\n        // the object sent to the UI thread. If the user really wants some objects\n        // to be mutable they should use shared values instead.\n        Object.freeze(value);\n      }\n      const adopted = NativeReanimatedModule.makeShareableClone(\n        toAdapt,\n        shouldPersistRemote\n      );\n      _shareableCache.set(value, adopted);\n      _shareableCache.set(adopted, _shareableFlag);\n      return adopted;\n    }\n  }\n  return NativeReanimatedModule.makeShareableClone(value, shouldPersistRemote);\n}\n\nconst WORKLET_CODE_THRESHOLD = 255;\n\nfunction getWorkletCode(value: __WorkletFunction) {\n  // @ts-ignore this is fine\n  const code = value?.__initData?.code;\n  if (!code) {\n    return 'unknown';\n  }\n  if (code.length > WORKLET_CODE_THRESHOLD) {\n    return `${code.substring(0, WORKLET_CODE_THRESHOLD)}...`;\n  }\n  return code;\n}\n\ntype RemoteFunction<T> = {\n  __remoteFunction: FlatShareableRef<T>;\n};\n\nfunction isRemoteFunction<T>(value: {\n  __remoteFunction?: unknown;\n}): value is RemoteFunction<T> {\n  'worklet';\n  return !!value.__remoteFunction;\n}\n\nexport function makeShareableCloneOnUIRecursive<T>(\n  value: T\n): FlatShareableRef<T> {\n  'worklet';\n  if (USE_STUB_IMPLEMENTATION) {\n    // @ts-ignore web is an interesting place where we don't run a secondary VM on the UI thread\n    // see more details in the comment where USE_STUB_IMPLEMENTATION is defined.\n    return value;\n  }\n  function cloneRecursive<T>(value: T): FlatShareableRef<T> {\n    if (\n      (typeof value === 'object' && value !== null) ||\n      typeof value === 'function'\n    ) {\n      if (isHostObject(value)) {\n        // We call `_makeShareableClone` to wrap the provided HostObject\n        // inside ShareableJSRef.\n        return _makeShareableClone(value) as FlatShareableRef<T>;\n      }\n      if (isRemoteFunction<T>(value)) {\n        // RemoteFunctions are created by us therefore they are\n        // a Shareable out of the box and there is no need to\n        // call `_makeShareableClone`.\n        return value.__remoteFunction;\n      }\n      if (Array.isArray(value)) {\n        return _makeShareableClone(\n          value.map(cloneRecursive)\n        ) as FlatShareableRef<T>;\n      }\n      const toAdapt: Record<string, FlatShareableRef<T>> = {};\n      for (const [key, element] of Object.entries(value)) {\n        toAdapt[key] = cloneRecursive<T>(element);\n      }\n      return _makeShareableClone(toAdapt) as FlatShareableRef<T>;\n    }\n    return _makeShareableClone(value);\n  }\n  return cloneRecursive(value);\n}\n\nexport function makeShareable<T>(value: T): T {\n  if (USE_STUB_IMPLEMENTATION) {\n    return value;\n  }\n  const handle = makeShareableCloneRecursive({\n    __init: () => {\n      'worklet';\n      return value;\n    },\n  });\n  registerShareableMapping(value, handle);\n  return value;\n}\n"]},"metadata":{},"sourceType":"module"}